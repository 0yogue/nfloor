generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS - Core business enums for RBAC and Licensing
// ============================================================================

enum LicenseType {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum AccessLevel {
  SUPER_ADMIN
  DIRECTOR
  SUPERINTENDENT
  MANAGER
  SELLER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ============================================================================
// COMPANY - Multi-tenant root entity
// ============================================================================

model Company {
  id                 String      @id @default(cuid())
  name               String
  slug               String      @unique
  license_type       LicenseType @default(BASIC)
  license_expires_at DateTime?
  is_active          Boolean     @default(true)
  created_at         DateTime    @default(now())
  updated_at         DateTime    @updatedAt

  areas        Area[]
  users        User[]
  integrations CompanyIntegration[]

  @@index([license_type])
  @@index([is_active])
}

// ============================================================================
// AREA - Organizational unit within a company
// ============================================================================

model Area {
  id         String   @id @default(cuid())
  name       String
  company_id String
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  company       Company       @relation(fields: [company_id], references: [id], onDelete: Cascade)
  users         User[]        @relation("UserArea")
  area_managers AreaManager[]

  @@unique([company_id, name])
  @@index([company_id])
  @@index([is_active])
}

// ============================================================================
// USER - Core user entity with RBAC
// ============================================================================

model User {
  id              String      @id @default(cuid())
  email           String      @unique
  password_hash   String
  name            String
  access_level    AccessLevel @default(SELLER)
  status          UserStatus  @default(ACTIVE)
  company_id      String?
  area_id         String?
  last_login_at   DateTime?
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  company       Company?      @relation(fields: [company_id], references: [id], onDelete: Cascade)
  area          Area?         @relation("UserArea", fields: [area_id], references: [id], onDelete: SetNull)
  managed_areas AreaManager[]
  sessions      Session[]

  @@index([company_id, access_level])
  @@index([area_id])
  @@index([status])
  @@index([email])
}

// ============================================================================
// AREA_MANAGER - Many-to-many: Users managing multiple areas
// ============================================================================

model AreaManager {
  user_id    String
  area_id    String
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  area Area @relation(fields: [area_id], references: [id], onDelete: Cascade)

  @@id([user_id, area_id])
  @@index([area_id])
}

// ============================================================================
// LEAD - Sales pipeline tracking
// ============================================================================

enum LeadStatus {
  LEAD
  VISIT
  CALLBACK
  PROPOSAL
  SOLD
  LOST
}

enum LeadSource {
  EMAIL
  WHATSAPP
  BALCAO
  CRM
  HUBSPOT
  ZAP_IMOVEIS
  OLX
  VIVA_REAL
  CHAVES_NA_MAO
  WEBSITE
  INDICATION
  OTHER
}

model Lead {
  id                String      @id @default(cuid())
  name              String
  first_name        String?
  last_name         String?
  phone             String?
  email             String?
  status            LeadStatus  @default(LEAD)
  source            LeadSource  @default(OTHER)
  notes             String?
  company_name      String?
  job_title         String?
  website           String?
  hubspot_id        String?
  hubspot_synced_at DateTime?
  seller_id         String
  area_id           String
  company_id        String
  created_at        DateTime    @default(now())
  updated_at        DateTime    @updatedAt

  @@index([seller_id])
  @@index([area_id])
  @@index([company_id])
  @@index([status])
  @@index([source])
  @@index([hubspot_id])
  @@index([created_at])
}

// ============================================================================
// SESSION - JWT session tracking for security and online status
// ============================================================================

model Session {
  id            String   @id @default(cuid())
  user_id       String
  token_hash    String   @unique
  expires_at    DateTime
  created_at    DateTime @default(now())
  last_used_at  DateTime @default(now())
  last_heartbeat DateTime @default(now())
  is_online     Boolean  @default(false)
  ip_address    String?
  user_agent    String?

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([expires_at])
  @@index([is_online])
}

// ============================================================================
// CONVERSATION - WhatsApp conversation with a lead
// ============================================================================

model Conversation {
  id                  String    @id @default(cuid())
  lead_id             String
  seller_id           String
  whatsapp_chat_id    String?
  status              ConversationStatus @default(ACTIVE)
  last_message_at     DateTime?
  last_seller_message DateTime?
  last_lead_message   DateTime?
  unread_count        Int       @default(0)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  messages        Message[]
  playbook_scores PlaybookScore[]

  @@unique([lead_id, seller_id])
  @@index([seller_id])
  @@index([status])
  @@index([last_message_at])
}

enum ConversationStatus {
  ACTIVE
  WAITING_RESPONSE
  CLOSED
  ARCHIVED
}

// ============================================================================
// MESSAGE - Individual messages in a conversation
// ============================================================================

model Message {
  id              String      @id @default(cuid())
  conversation_id String
  sender_type     SenderType
  content         String
  whatsapp_id     String?
  response_time   Int?
  created_at      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@index([sender_type])
  @@index([created_at])
}

enum SenderType {
  SELLER
  LEAD
  SYSTEM
}

// ============================================================================
// PLAYBOOK_SCORE - AI evaluation of conversation quality
// ============================================================================

model PlaybookScore {
  id              String   @id @default(cuid())
  conversation_id String
  seller_id       String
  score           Float
  feedback        String?
  criteria        Json?
  created_at      DateTime @default(now())

  conversation Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([seller_id])
  @@index([conversation_id])
  @@index([created_at])
}

// ============================================================================
// PLAYBOOK - Configurable playbook template for evaluation
// ============================================================================

model Playbook {
  id          String   @id @default(cuid())
  company_id  String
  name        String
  content     String
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([company_id])
  @@index([is_active])
}

// ============================================================================
// COMPANY_INTEGRATION - API keys and integration settings per company
// ============================================================================

enum IntegrationType {
  HUBSPOT
  EVOLUTION_API
  SMTP
  IMAP
}

model CompanyIntegration {
  id           String          @id @default(cuid())
  company_id   String
  type         IntegrationType
  name         String
  api_key      String?
  api_url      String?
  config       Json            @default("{}")
  is_active    Boolean         @default(true)
  last_sync_at DateTime?
  sync_error   String?
  created_at   DateTime        @default(now())
  updated_at   DateTime        @updatedAt

  company Company @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@unique([company_id, type])
  @@index([company_id])
  @@index([type])
}

// ============================================================================
// HUBSPOT_SYNC_LOG - Tracking sync operations with HubSpot
// ============================================================================

model HubSpotSyncLog {
  id                String    @id @default(cuid())
  company_id        String
  direction         String    // 'IMPORT' or 'EXPORT'
  entity_type       String    // 'CONTACT', 'DEAL', etc.
  records_processed Int       @default(0)
  records_created   Int       @default(0)
  records_updated   Int       @default(0)
  records_failed    Int       @default(0)
  error_details     Json?
  started_at        DateTime  @default(now())
  completed_at      DateTime?
  status            String    @default("RUNNING") // 'RUNNING', 'COMPLETED', 'FAILED'

  @@index([company_id])
  @@index([started_at])
}
